name: 'build and deploy Speckle functions - TESTING'
on:
  workflow_dispatch:
    inputs:
      test_token:
        description: 'Temporary token for testing (WILL BE VISIBLE IN LOGS!)'
        required: true
        type: string
      test_function_id:
        description: 'Function ID for testing'
        required: true
        type: string

jobs:
  publish-automate-function-version:
    env:
      FUNCTION_SCHEMA_FILE_NAME: functionSchema.json
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.1.7
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Use workflow inputs instead of secrets (TEMPORARY ONLY!)
      - name: ⚠️ USING MANUAL INPUTS FOR TESTING ONLY ⚠️
        run: |
          echo "WARNING: Using manual inputs - token will be visible in logs!"
          echo "This is for testing only - do not use in production!"
          
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install specklepy==2.21.4
          pip install pytest==7.4.2
          pip install black==23.3.0
          pip install ruff==0.0.271
          pip install mypy==1.3.0
          pip install pydantic-settings==2.3.0
          pip install git+https://github.com/specklesystems/speckle-automate-python.git
          
      - name: Run tests
        run: |
          if [ -d "tests" ]; then
            python -m pytest tests/ -v
          else
            echo "No tests directory found, skipping tests"
          fi
        continue-on-error: true

      - name: Run code formatting check
        run: |
          python -m black --check .
        continue-on-error: true
          
      - name: Extract functionInputSchema
        id: extract_schema
        run: |
          python main.py generate_schema ${{ env.FUNCTION_SCHEMA_FILE_NAME }}
          
      # Test authentication manually first
      - name: Test Authentication
        run: |
          echo "Testing authentication with provided credentials..."
          response=$(curl -s -w "%{http_code}" \
            -H "Authorization: Bearer ${{ github.event.inputs.test_token }}" \
            https://automate.speckle.dev/api/v1/functions 2>/dev/null | tail -1)
          
          echo "HTTP Response Code: $response"
          
          case $response in
            200|201) echo "✅ Authentication successful!" ;;
            401) echo "❌ Authentication failed - check your token" ;;
            403) echo "❌ Authentication failed - insufficient permissions" ;;
            *) echo "❓ Unexpected response: $response" ;;
          esac
          
      - name: Speckle Automate Function - Build and Publish
        uses: specklesystems/speckle-automate-github-composite-action@0.8.1
        with:
          speckle_automate_url: 'https://automate.speckle.dev'
          speckle_token: ${{ github.event.inputs.test_token }}
          speckle_function_id: ${{ github.event.inputs.test_function_id }}
          speckle_function_input_schema_file_path: ${{ env.FUNCTION_SCHEMA_FILE_NAME }}
          speckle_function_command: 'python -u main.py run'